services:
  # ===================
  # PostgreSQL - shared by Dendrite and Leaknote
  # ===================
  postgres:
    image: postgres:16-alpine
    container_name: leaknote-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
      # Database passwords for init-db.sh
      LEAKNOTE_DB_PASSWORD: ${LEAKNOTE_DB_PASSWORD:?LEAKNOTE_DB_PASSWORD required}
      DENDRITE_DB_PASSWORD: ${DENDRITE_DB_PASSWORD:?DENDRITE_DB_PASSWORD required}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/01-init-db.sh:ro
      - ./schema.sql:/docker-entrypoint-initdb.d/02-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - leaknote-net

  # ===================
  # Dendrite Matrix Server
  # ===================
  dendrite:
    image: matrixdotorg/dendrite-monolith:latest
    container_name: leaknote-dendrite
    hostname: dendrite
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8008:8008"   # Client-Server API
      - "8448:8448"   # Federation (optional)
    volumes:
      - ./dendrite/config:/etc/dendrite
      - ./dendrite/media:/var/dendrite/media
      - ./dendrite/jetstream:/var/dendrite/jetstream
      - ./dendrite/searchindex:/var/dendrite/searchindex
    networks:
      - leaknote-net

  # ===================
  # Leaknote Bot
  # ===================
  leaknote:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: leaknote-bot
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      dendrite:
        condition: service_started
    environment:
      # Python path for imports
      PYTHONPATH: /app

      # Matrix - points to local Dendrite
      MATRIX_HOMESERVER: http://dendrite:8008
      MATRIX_USER_ID: ${MATRIX_USER_ID:-@leaknote:localhost}
      MATRIX_PASSWORD: ${MATRIX_PASSWORD:?MATRIX_PASSWORD required}
      MATRIX_INBOX_ROOM: ${MATRIX_INBOX_ROOM:-#leaknote-inbox:localhost}

      # Database
      DATABASE_URL: postgresql://leaknote:${LEAKNOTE_DB_PASSWORD:-leaknote}@postgres:5432/leaknote

      # Classification LLM (cheap, fast)
      CLASSIFY_PROVIDER: ${CLASSIFY_PROVIDER:-openai}
      CLASSIFY_API_URL: ${CLASSIFY_API_URL:?CLASSIFY_API_URL required}
      CLASSIFY_API_KEY: ${CLASSIFY_API_KEY:?CLASSIFY_API_KEY required}
      CLASSIFY_MODEL: ${CLASSIFY_MODEL:-glm-4}

      # Summary LLM (quality)
      SUMMARY_PROVIDER: ${SUMMARY_PROVIDER:-openai}
      SUMMARY_API_URL: ${SUMMARY_API_URL:?SUMMARY_API_URL required}
      SUMMARY_API_KEY: ${SUMMARY_API_KEY:?SUMMARY_API_KEY required}
      SUMMARY_MODEL: ${SUMMARY_MODEL:-anthropic/claude-sonnet-4}

      # Settings
      CONFIDENCE_THRESHOLD: ${CONFIDENCE_THRESHOLD:-0.6}
      DIGEST_TARGET_USER: ${DIGEST_TARGET_USER:?DIGEST_TARGET_USER required}
    volumes:
      - ./logs:/app/logs
    networks:
      - leaknote-net

  # ===================
  # Leaknote Admin UI
  # ===================
  leaknote-admin:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: leaknote-admin
    restart: unless-stopped
    command: uvicorn leaknote.admin.app:app --host 0.0.0.0 --port 8000
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Python path for imports
      PYTHONPATH: /app

      # Database
      DATABASE_URL: postgresql://leaknote:${LEAKNOTE_DB_PASSWORD:-leaknote}@postgres:5432/leaknote

      # Admin UI credentials
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD required}
    ports:
      - "8000:8000"  # Only accessible via Tailscale
    networks:
      - leaknote-net
    env_file:
      - .env

networks:
  leaknote-net:
    driver: bridge
