services:
  # ===================
  # PostgreSQL Database
  # ===================
  postgres:
    image: postgres:16-alpine
    container_name: leaknote-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
      # Database password for init-db.sh
      LEAKNOTE_DB_PASSWORD: ${LEAKNOTE_DB_PASSWORD:?LEAKNOTE_DB_PASSWORD required}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/01-init-db.sh:ro
      - ./schema.sql:/docker-entrypoint-initdb.d/02-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - leaknote-net

  # ===================
  # Leaknote Bot
  # ===================
  leaknote:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: leaknote-bot
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Python path for imports
      PYTHONPATH: /app

      # Telegram
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN required}
      TELEGRAM_OWNER_ID: ${TELEGRAM_OWNER_ID:?TELEGRAM_OWNER_ID required}
      TELEGRAM_INBOX_CHAT_ID: ${TELEGRAM_INBOX_CHAT_ID:-0}

      # Database
      DATABASE_URL: postgresql://leaknote:${LEAKNOTE_DB_PASSWORD:-leaknote}@postgres:5432/leaknote

      # Classification LLM (cheap, fast)
      CLASSIFY_PROVIDER: ${CLASSIFY_PROVIDER:-openai}
      CLASSIFY_API_URL: ${CLASSIFY_API_URL:?CLASSIFY_API_URL required}
      CLASSIFY_API_KEY: ${CLASSIFY_API_KEY:?CLASSIFY_API_KEY required}
      CLASSIFY_MODEL: ${CLASSIFY_MODEL:-glm-4}

      # Summary LLM (quality)
      SUMMARY_PROVIDER: ${SUMMARY_PROVIDER:-openai}
      SUMMARY_API_URL: ${SUMMARY_API_URL:?SUMMARY_API_URL required}
      SUMMARY_API_KEY: ${SUMMARY_API_KEY:?SUMMARY_API_KEY required}
      SUMMARY_MODEL: ${SUMMARY_MODEL:-anthropic/claude-sonnet-4}

      # Settings
      CONFIDENCE_THRESHOLD: ${CONFIDENCE_THRESHOLD:-0.6}
    volumes:
      - ./logs:/app/logs
    networks:
      - leaknote-net

  # ===================
  # Leaknote Admin UI
  # ===================
  leaknote-admin:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: leaknote-admin
    restart: unless-stopped
    command: uvicorn leaknote.admin.app:app --host 0.0.0.0 --port 8000
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Python path for imports
      PYTHONPATH: /app

      # Database
      DATABASE_URL: postgresql://leaknote:${LEAKNOTE_DB_PASSWORD:-leaknote}@postgres:5432/leaknote

      # Admin UI credentials
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD required}
    ports:
      - "8000:8000"  # Only accessible via Tailscale
    networks:
      - leaknote-net
    env_file:
      - .env

networks:
  leaknote-net:
    driver: bridge
